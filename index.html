<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Fiona's Bus Times</title>
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: #e2a8a8;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}
h1 {
    font-size: 1.5rem;
    margin-bottom: 20px;
}
.stop {
    width: 90%;
    background-color: #ffc3c3;
    padding: 15px;
    margin: 10px 0;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.stop h2 {
    margin: 0 0 10px 0;
    font-size: 1.2rem;
}
.arrival {
    font-size: 1.5rem;
    font-weight: bold;
}
.arrival.green { color: green; }
.arrival.yellow { color: orange; }
.arrival.red { color: red; }
</style>
</head>
<body>
<h1>Fiona's Bus Times</h1>

<div class="stop" id="stop1">
    <h2>NW Kings Blvd & NW Taylor Ave (Route 5 → OSU/Downtown)</h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop2">
    <h2>NW Kings Blvd & NW Monroe Ave (Route 5 → Timberhill)</h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<script>
// CTS "Text View" URLs with CORS proxy
const stopUrls = [
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=14484',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=14599'
];

function getColor(mins) {
    if (mins < 5) return 'green';
    if (mins <= 15) return 'yellow';
    return 'red';
}

async function fetchBusTimes() {
    for (let i = 0; i < stopUrls.length; i++) {
        try {
            const response = await fetch(stopUrls[i]);
            const html = await response.text();

            // Match all <li>In XX min</li>
            const matches = [...html.matchAll(/<li>In (\d+) min<\/li>/g)];
            const arrivals = matches.map(m => parseInt(m[1], 10));

            const arrivalElems = document.querySelectorAll(`#stop${i+1} .arrival`);
            arrivalElems.forEach((el, j) => {
                if (arrivals[j] !== undefined) {
                    el.innerText = `in ${arrivals[j]} min`;
                    el.className = 'arrival ' + getColor(arrivals[j]);
                    el.style.display = 'block'; 
                } else {
                    el.style.display = 'none'; 
                }
            });

        } catch (e) {
            console.error(e);
            const arrivalElems = document.querySelectorAll(`#stop${i+1} .arrival`);
            arrivalElems.forEach(el => {
                el.innerText = 'Error';
                el.className = 'arrival';
            });
        }
    }
}

// Initial fetch
fetchBusTimes();

// Refresh every 30 seconds
setInterval(fetchBusTimes, 30000);
</script>
</body>
</html>
