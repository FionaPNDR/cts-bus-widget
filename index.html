<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="cts-icon.png">
<link rel="icon" type="image/png" href="cts-favicon.png" sizes="32x32">
<title>CTS Bus Times</title>
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: #ffffff;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}
h1 {
    font-size: 1.5rem;
    margin-bottom: 20px;
}
.stop {
    width: 90%;
    background-color: #ffe3ed;
    padding: 15px;
    margin: 10px 0;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    line-height: 0.8
}
.stop h2 {
    margin: 0 0 10px 0;
    font-size: 1.2rem;
}
.arrival {
    font-size: 1.3rem;
    font-weight: bold;
}
.arrival.green { color: green; }
.arrival.yellow { color: rgb(255, 153, 0); }
.arrival.red { color: red; }
</style>
</head>
<body>
<h1>Fiona & Alice's CTS Bus Times</h1>

<div class="stop" id="stop1">
    <h2>Kings & Taylor (Route 5 → OSU)</h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop2">
    <h2>Kings & Monroe (Route 5 → Fred Meyer)</h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop3" style="background-color: #fff6d8;">
    <h2>29th & Grant (Route 7 → Home Depot)</h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop4" style="background-color: #fff6d8;">
    <h2>Circle & Four Acre (Route 7 → Witham Hill)</h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<script>
// CTS "Text View" URLs with CORS proxy
const stopUrls = [
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=14484',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=14599',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=12567',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=11043'
];

function getColor(mins, rthresh, ythresh) {
    if (mins <= rthresh) return 'red';
    if (mins <= ythresh) return 'yellow';
    return 'green';
}

async function fetchBusTimes() {
    for (let i = 0; i < stopUrls.length; i++) {
        try {
            const response = await fetch(stopUrls[i]);
            const html = await response.text();

            // Match all <li>In XX min</li>
            const matches = [...html.matchAll(/<li>In (\d+) min<\/li>/g)];
            const arrivals = matches.map(m => parseInt(m[1], 10));

            const arrivalElems = document.querySelectorAll(`#stop${i+1} .arrival`);
            arrivalElems.forEach((el, j) => {
                if (arrivals[j] !== undefined) {
                    el.innerText = `in ${arrivals[j]} minutes`;
                    let rthresh = 5, ythresh = 15;
                    if (i == 2)
                        rthresh = 25, ythresh = 40;
                    if (i == 3)
                        rthresh = 10, ythresh = 20;
                    el.className = 'arrival ' + getColor(arrivals[j], rthresh, ythresh);
                    el.style.display = 'block'; 
                } else {
                    el.style.display = 'none'; 
                }
            });

        } catch (e) {
            console.error(e);
            const arrivalElems = document.querySelectorAll(`#stop${i+1} .arrival`);
            arrivalElems.forEach(el => {
                el.innerText = 'Error';
                el.className = 'arrival';
            });
        }
    }
}

// Initial fetch
fetchBusTimes();

// Refresh every 30 seconds
setInterval(fetchBusTimes, 30000);
</script>
</body>
</html>
