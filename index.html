<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="cts-icon.png">
<link rel="icon" type="image/png" href="cts-favicon.png" sizes="32x32">

<title>CTS Bus Times</title>

<style>
body 
{
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: #ffffff;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

h1 
{
    font-size: 1.5rem;
    margin-bottom: 20px;
}

.stop 
{
    width: 90%;
    background-color: #ffe3ed;
    padding: 15px;
    margin: 12px 0;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.stop h2 
{
    margin: 0 0 10px 0;
    font-size: 1.2rem;
}

.stop h2 a
{
    color: inherit;        /* use the same color as surrounding text */
    text-decoration: none; /* remove underline */
    cursor: pointer;       /* still shows pointer on hover */
}

.arrival 
{
    font-size: 1.4rem;
    font-weight: bold;
}

.arrival.green { color: #008000; }
.arrival.yellow { color: #ff9900; }
.arrival.red { color: #ff0000 }

</style>

</head>
<body>
<h1>Fiona & Alice's CTS Bus Times</h1>

<div class="stop" id="stop1">
    <h2>
        <a href="https://www.corvallistransit.com/rtt/public/?page=text&pln=14484" target="_blank">
            Kings & Taylor (→ OSU)
        </a>
    </h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop2">
    <h2>
        <a href="https://www.corvallistransit.com/rtt/public/?page=text&pln=14599" target="_blank">
            Kings & Monroe (→ Fred Meyer)
        </a>
    </h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop3" style="background-color: #fff6d8;">
    <h2>
        <a href="https://www.corvallistransit.com/rtt/public/?page=text&pln=12567" target="_blank">
            29th & Grant (→ Home Depot)
        </a>
    </h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<div class="stop" id="stop4" style="background-color: #fff6d8;">
    <h2>
        <a href="https://www.corvallistransit.com/rtt/public/?page=text&pln=11043" target="_blank">
            Circle & Four Acre (→ Witham Hill)
        </a>
    </h2>
    <p class="arrival">Loading...</p>
    <p class="arrival">Loading...</p>
</div>

<script>

const stopUrls = [
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=14484',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=14599',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=12567',
    'https://corsproxy.io/?https://www.corvallistransit.com/rtt/public/?page=text&pln=11043'
];

function getColor(mins, rthresh, ythresh) 
{
    if (mins <= rthresh) return 'red';
    if (mins <= ythresh) return 'yellow';
    return 'green';
}

async function fetchBusTimes() 
{
    for (let i = 0; i < stopUrls.length; i++) {
        try {
            const response = await fetch(stopUrls[i]);
            const html = await response.text();

            // Match all <li>In XX min</li>
            const matches = [...html.matchAll(/<li>In (\d+) min<\/li>/g)];
            const arrivals = matches.map(m => parseInt(m[1], 10));

            const arrivalElems = document.querySelectorAll(`#stop${i+1} .arrival`);
            arrivalElems.forEach((el, j) => {
                if (arrivals[j] !== undefined) {
                    el.innerText = `in ${arrivals[j]} minutes`; 
                    let rthresh = 5, ythresh = 15; // red if <= 5 mins, yellow if <= 15 mins
                    if (i == 2)
                        rthresh = 25, ythresh = 40;
                    if (i == 3)
                        rthresh = 10, ythresh = 20;
                    el.className = 'arrival ' + getColor(arrivals[j], rthresh, ythresh);
                    el.style.display = 'block'; 
                } else {
                    el.style.display = 'none'; 
                }
            });

        } catch (e) {
            console.error(e);
            const arrivalElems = document.querySelectorAll(`#stop${i+1} .arrival`);
            arrivalElems.forEach(el => {
                el.innerText = 'Error: No bus time found';
                el.className = 'arrival';
            });
        }
    }
}

// Initial bus time fetch
fetchBusTimes();

// Refresh every 30 seconds
setInterval(fetchBusTimes, 15000);
</script>
</body>
</html>
